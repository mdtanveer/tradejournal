{% extends "layout.html" %}

{% block content %}
    <div class="container">
        <link rel="stylesheet" type="text/css" href="/static/content/chart.css">
        <div class="btn-toolbar mb-3" role="toolbar" aria-label="Toolbar with button groups">
            <div class="btn-group mr-2" role="group" aria-label="First group">
                <button type="button" class="btn btn-secondary btn-success" onclick="g_chartInstance.RenderPreviousChart();">
                    <span class="glyphicon glyphicon-chevron-left"></span>
                </button>
                <button type="button" class="btn btn-secondary btn-success" onclick="g_chartInstance.RenderNextChart();">
                    <span class="glyphicon glyphicon-chevron-right"></span>
                </button>
                <button type="button" class="btn btn-secondary btn-warning" onclick="g_chartInstance.ToggleIndicator();">
                    <span class="glyphicon glyphicon-barcode"></span>
                </button>
            </div>
            <div>
                <center>
                    <h5 id="title"></h5>
                </center>
            </div>
        </div>
        <div id="main">
            <div id="chart"></div>
        </div>
        <form class="input-group" method="post" role="form">
            <input type="text" class="form-control" id="title" name="title">
            <div class="input-group-btn">
                <button type="submit" class="btn btn-success">
                    &zwnj;<span class="glyphicon glyphicon-camera"></span>
                </button>
                <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    &zwnj;<span class="caret"></span>
                    <span class="sr-only">Toggle Dropdown</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-right">
                    <li>
                        <a href="javascript:g_chartInstance.DeleteCurrentChart();">
                            Delete
                        </a>
                    </li>
                </ul>
            </div>
        </form>
        <div class="btn-toolbar mb-3" role="toolbar" aria-label="Toolbar with button groups">
            <div class="btn-group mr-2" role="group" aria-label="First group">
                <button type="button" class="btn btn-secondary btn-success" onclick="g_chartInstance.RenderCurrentChartResampleTF('original');">O</button>
                <button type="button" class="btn btn-secondary btn-success" onclick="g_chartInstance.RenderCurrentChartResampleTF('mother');">M</button>
                <button type="button" class="btn btn-secondary btn-success" onclick="g_chartInstance.RenderCurrentChartResampleTF('latest_{{journalentry.symbol}}');">L</button>
            </div>
        </div>
    </div>
        <script type="text/javascript" src="/static/scripts/d3.v4.min.js"></script>
        <script type="text/javascript" src="/static/scripts/techan.min.js"></script>
        <script type="text/javascript" src="/static/scripts/tradejournalchart.js"></script>
        <script type="text/javascript">
            var parseDate = d3.timeParse("%Y-%m-%d %H:%M:%S");
            var charts = JSON.parse('{{ charts | safe}}');
            {%if trades|length != 0%}
                const trades = [
                {%for trade in trades%}
                {
                    date: parseDate("{{ trade.date|formatdatetimed3 }}"),
                    type: "{{ trade.type }}",
                    price: {{ trade.price }},
                    quantity: {{ trade.quantity }} 
                },
                {%endfor%}
            ];
            {%elif journalentry and not not journalentry.entry_price %}
                const tradearrowoffsetperc = 0.01;
                const tradearrowoffsetentry = 1 + {{ -1 if journalentry.direction == 'LONG' else 1}}* tradearrowoffsetperc;
                const tradearrowoffsetexit = 1 + {{ 1 if journalentry.direction == 'LONG' else -1}}* tradearrowoffsetperc;
                const trades = [
                {
                    date: parseDate("{{ journalentry.entry_time|formatdatetimed3 }}"),
                    type: "{{ 'buy' if journalentry.direction == 'LONG' else 'sell'}}",
                    price: {{ journalentry.entry_price }}* tradearrowoffsetentry,
                    quantity: {{ journalentry.quantity }} 
                }
            {% if not not journalentry.exit_price %}
                , {
                    date: parseDate("{{ journalentry.exit_time|formatdatetimed3 }}"),
                    type: "{{ 'sell' if journalentry.direction == 'LONG' else 'buy'}}",
                    price: {{ journalentry.exit_price }}* tradearrowoffsetexit,
                    quantity: {{ journalentry.quantity }}
                }
            {%endif%}
        ];
            {%else%}
                const trades = [];
            {% endif %}
            var secondaryIndicator = "{{ indicator }}";
            var primaryIndicator = "{{overlay_indicator if not not overlay_indicator else 'ichimoku'}}";

            var g_chartInstance = new TJChart("{{journalentry.symbol}}", charts, trades, "{{journalentry.timeframe}}", primaryIndicator, secondaryIndicator);
            if (charts.length > 0) {
                g_chartInstance.RenderChart();
            }
            else {
                document.getElementById('title').innerText = "No charts available";
                document.getElementById('main').hidden = true;
            }
        </script>
{% endblock %}
