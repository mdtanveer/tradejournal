{% extends "layout.html" %}

{% block content %}
    <div class="container">
        <link rel="stylesheet" type="text/css" href="/static/content/chart.css">
        <div class="btn-toolbar mb-3" role="toolbar" aria-label="Toolbar with button groups">
            <div class="btn-group mr-2" role="group" aria-label="First group">
                <button type="button" class="btn btn-secondary btn-success" onclick="g_chartInstance.RenderPreviousChart();">
                    <span class="glyphicon glyphicon-chevron-left"></span>
                </button>
                <button type="button" class="btn btn-secondary btn-success" onclick="g_chartInstance.RenderNextChart();">
                    <span class="glyphicon glyphicon-chevron-right"></span>
                </button>
                <button type="button" class="btn btn-secondary btn-warning" onclick="g_chartInstance.ToggleIndicator();">
                    <span class="glyphicon glyphicon-barcode"></span>
                </button>
                <button type="button" class="btn btn-secondary btn-success" onclick="g_chartInstance.RenderCurrentChartResampleTF('original');">O</button>
                <button type="button" class="btn btn-secondary btn-success" onclick="g_chartInstance.RenderCurrentChartResampleTF('mother');">M</button>
                <button type="button" class="btn btn-secondary btn-success" onclick="g_chartInstance.RenderCurrentChartResampleTF('latest_{{journalentry.symbol}}');">L</button>
                <button id="chartcapturebutton" type="submit" class="btn btn-success">
                    &zwnj;<span class="glyphicon glyphicon-camera"></span>
                </button>
                <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    &zwnj;<span class="caret"></span>
                    <span class="sr-only">Toggle Dropdown</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-right">
                    <li>
                        <a href="/journalentry/{{journalentry.key}}/edit">Edit</a>
                        <a href="javascript:g_chartInstance.DeleteCurrentChart();"> Delete </a>
                    </li>
                </ul>
            </div>
        </div>
        <div id="main">
            <div id="chart"></div>
        </div>
        <h4>
            {%if not not journalentry.is_idea%}
                <span class="glyphicon glyphicon-fire text-warning"></span>
            {%else%}
                {%if journalentry.is_open()%}
                    <span class="glyphicon glyphicon-play-circle text-primary"></span>
                {%else%}
                    {%if journalentry.is_profitable()%}
                        <span class="glyphicon glyphicon-circle-arrow-up text-success"></span>
                    {%else%}
                        <span class="glyphicon glyphicon-circle-arrow-down text-danger"></span>
                    {%endif%}
                {%endif%}
            {%endif%}
            {{journalentry.symbol}} (<i>{{ journalentry.direction.lower()}},&nbsp;{{ journalentry.strategy.lower()}},&nbsp;{{ journalentry.timeframe.lower()}}</i>)
        </h4>
    <table class="table">
        <tr class="form-group">
            <td>Entry Time</td>
            <td>{{journalentry.entry_time|formatdatetimedisplay}}</td>
        </tr>
        <tr>
            <td>Exit Time</td>
            <td>{{journalentry.exit_time | formatdatetimedisplay if not zero_exit else ''}}</td>
        </tr>
        <tr>
            <td>Entry Price</td>
            <td>{{journalentry.entry_price}}</td>
        </tr>
        <tr>
            <td>Exit Price</td>
            <td>{{journalentry.exit_price}}</td>
        </tr>
        <tr>
            <td>Quantity</td>
            <td>{{journalentry.quantity}}</td>
        </tr>
        <tr>
            <td>Rating</td>
            <td>{{journalentry.rating}}</td>
        </tr>
    </table>

<h4> Comments </h4>
<br />
{% if comments %}
<table class="table table-hover">
    {% for comment in comments %}
    <tr>
        <th>
            {{ comment.add_time | formatdatetimedisplay }}
        </th>
        <td>
            {%if comment.title %}
            <b>
                {{ comment.title }}
            </b><br />
            {% endif %}
            {{ comment.text }}
        </td>
    </tr>
    {% endfor %}
</table>
{{ pagination.links }}
{% else %}
<p>No comments available.</p>
<br />
{% endif %}
<form action="" method="post" role="form" id="commentform">
    <div class="form-group">
        <div class="input text">
            <label for="title">Title:</label>
            <input class="form-control" id="title" name="title" type="text" value="">
        </div>
        <div class="input text">
            <label for="text">Text:</label>
            <textarea class="form-control" id="text" name="text" required></textarea>
        </div>
    </div>
    <button type="submit" class="btn btn-success" id="postcommentbutton">Post Comment</button>
</form>

        <script type="text/javascript" src="/static/scripts/d3.v4.min.js"></script>
        <script type="text/javascript" src="/static/scripts/techan.min.js"></script>
        <script type="text/javascript" src="/static/scripts/tradejournalchart.js"></script>
        <script type="text/javascript" src="/static/scripts/jquery-1.10.2.js"></script>
        <script type="text/javascript">
            $("#postcommentbutton").click(function(event){        
                event.preventDefault();
                $.post("/journalentry/{{journalentry.key}}/comments", $("#commentform").serialize(), function(data) {
                    $("#commentform")[0].reset();
                    window.location.reload();
                });
                });   
            $("#chartcapturebutton").click(function(event){        
                $.post("/journalentry/{{journalentry.key}}/charts", {}, function(data) {
                    window.location.reload();
                });
                });   
        </script>

        <script type="text/javascript">
            var parseDate = d3.timeParse("%Y-%m-%d %H:%M:%S");
            var charts = JSON.parse('{{ charts | safe}}');
            {%if trades|length != 0%}
                const trades = [
                {%for trade in trades%}
                {
                    date: parseDate("{{ trade.date|formatdatetimed3 }}"),
                    type: "{{ trade.type }}",
                    price: {{ trade.price }},
                    quantity: {{ trade.quantity }} 
                },
                {%endfor%}
            ];
            {%elif journalentry and not not journalentry.entry_price %}
                const tradearrowoffsetperc = 0.01;
                const tradearrowoffsetentry = 1 + {{ -1 if journalentry.direction == 'LONG' else 1}}* tradearrowoffsetperc;
                const tradearrowoffsetexit = 1 + {{ 1 if journalentry.direction == 'LONG' else -1}}* tradearrowoffsetperc;
                const trades = [
                {
                    date: parseDate("{{ journalentry.entry_time|formatdatetimed3 }}"),
                    type: "{{ 'buy' if journalentry.direction == 'LONG' else 'sell'}}",
                    price: {{ journalentry.entry_price }}* tradearrowoffsetentry,
                    quantity: {{ journalentry.quantity }} 
                }
            {% if not not journalentry.exit_price %}
                , {
                    date: parseDate("{{ journalentry.exit_time|formatdatetimed3 }}"),
                    type: "{{ 'sell' if journalentry.direction == 'LONG' else 'buy'}}",
                    price: {{ journalentry.exit_price }}* tradearrowoffsetexit,
                    quantity: {{ journalentry.quantity }}
                }
            {%endif%}
        ];
            {%else%}
                const trades = [];
            {% endif %}
            var secondaryIndicator = "{{ indicator }}";
            var primaryIndicator = "{{overlay_indicator if not not overlay_indicator else 'ichimoku'}}";

            var g_chartInstance = new TJChart("{{journalentry.key}}", "{{journalentry.symbol}}", charts, 
                trades, "{{journalentry.timeframe}}", primaryIndicator, secondaryIndicator);
            if (charts.length > 0) {
                g_chartInstance.RenderChart();
            }
            else {
                document.getElementById('title').innerText = "No charts available";
                document.getElementById('main').hidden = true;
            }
        </script>
{% endblock %}
